# CrimLog API

The CrimLog API is the backbone of the CrimLog protocol. It is a [GraphQL](https://graphql.org/) API written in [TypeScript](https://www.typescriptlang.org/) with the [Nest.js](http://nestjs.com/) framework. [Prisma](https://prisma.io/) is used as the ORM and [pnpm](https://pnpm.io/) as the package manager.

# Project Setup

## Prerequisites

-   Node.js v16.18 or greater (https://nodejs.org/en/download/releases/)
-   pnpm v7.x (https://pnpm.io/installation)
-   Git (https://git-scm.com/downloads)
-   MongoDB (https://www.mongodb.com/docs/manual/tutorial/getting-started/)

## Install Dependencies

This is a [pnpm](https://pnpm.io/) project, and the usage of other package managers such as npm or yarn is strongly discouraged. After installing Node.js, pnpm can be enabled using the built-in [Corepack](https://nodejs.org/api/corepack.html) API. Run the following commands to setup pnpm on your system:

```cmd
corepack enable
corepack prepare pnpm@latest --activate
```

Once pnpm has been enabled on your system, navigate to the root directory and execute the command:

```cmd
pnpm install --frozen-lockfile
```

This command locally installs all the project dependencies may take some time to run.

Afterwards, setup a template `.env` file by copying the contents of the `.env.sample` file into a new `.env` file located in the root.

## Auto-generated Code

CrimLog makes use of several code generation tools to improve the development experience. It is important to regenerate files after making changes to certain areas of the codebase.

### Prisma

[Prisma](https://prisma.io/), an ORM, provides complete and thorough TypeScript types for all database models and queries. The `schema.prisma` file is the single source of truth for these types.

Whenever the `schema.prisma` is updated, the `prisma:generate` script will need to be run to regenerate the Prisma types. Alternativel, `prisma:generate:w` can be run once to continuously watch the Prisma schema file and regenerate types automatically on save. Run this command to autogenerate the entire Prisma client into your `node_modules/` folder (necessary before proceeding to the [Database](#database) section):

```cmd
pnpm prisma:generate
```

The autogenerated Prisma typings are not committed to the source repository.

### GraphQL

CrimLog uses a software tool to convert [GraphQL](https://graphql.org/) schema into TypeScript types. This comes in handy for input types, especially in the case of data validation. All autogenerated typings are stored in the `graphql/typings.ts` file and committed to the source repository.

Whenever any GraphQL file is updated, the `graphql-codegen` script should be run to regenerate the `typings.ts` file:

```cmd
pnpm graphql-codegen
```

## Database

[MongoDB](https://www.mongodb.com/) is the API's database provider. Once you've created your own MongoDB instance, obtain the connection string and set that as the value of the `DATABASE_URL` environment variable.

To seed your database with some sample data, first run the ` prisma:push` script. This will apply the Prisma schema to your newly-created Mongo database. Then execute the `prisma:seed` script to populate the database.

```cmd
pnpm prisma:push
pnpm prisma:seed
```

## Nest.js API

[Nest.js](http://nestjs.com/) has a CLI that is used for compiling the source files into the local `dist/` folder. To compile the API in a development envrionment, run the command:

```cmd
pnpm start:dev
```

Once you see the console should output successful startup messages, you should be able to navigate to http://localhost:3000/graphql and interact with the API through the Apollo Playground.

This command also places the API in watch mode- any changes made to TS files will automatically be recompiled and redeployed by Nest.

**At this point, the project should be setup and ready for local development.**
